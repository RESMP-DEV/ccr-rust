# Claude Code API Research

This document documents Claude Code's HTTP API request patterns and headers for the ccr-rust router implementation.

## Headers

### Core Request Headers

These are the standard headers required to make a valid API request to Anthropic's Claude API.

| Header | Description | Example |
|--------|-------------|---------|
| `x-api-key` | Authentication token for the API. | `x-api-key: YOUR_API_KEY` |
| `content-type` | Specifies the request body format. | `content-type: application/json` |
| `anthropic-version` | Specifies the API version date. | `anthropic-version: 2023-06-01` |

While `ccr-rust` primarily uses `anthropic-*` headers for client *detection*, these core headers are fundamental for direct API communication.

### Custom Headers (anthropic-*)

Claude Code sends the following Anthropic-specific headers with API requests:

| Header | Description | Example |
|--------|-------------|---------|
| `anthropic-client-id` | Client identifier for tracking | `anthropic-client-id: claude-cli` |
| `anthropic-version` | Anthropic API version date | `anthropic-version: 2023-06-01` |

Any header prefixed with `anthropic-*` is used by ccr-rust to detect Claude Code as the frontend client.

### Beta Headers

| Header | Description | Notes |
|--------|-------------|-------|
| `anthropic-beta` | Enables beta features (e.g., prompt caching) | **CRITICAL**: Must be stripped when forwarding to non-Anthropic providers (e.g., DeepSeek) to avoid 400 Bad Request errors. |

The `anthropic-beta` header is not supported by all backend providers and is actively removed by transformers when routing to providers like DeepSeek or OpenAI.

### User-Agent Pattern

Claude Code does **not** rely on a specific User-Agent string for detection. While standard HTTP clients send a User-Agent, ccr-rust ignores it for Claude Code detection to remain robust against client updates.

Instead, detection is based on:

1. **Primary**: Presence of `anthropic-*` headers (Strongest signal)
2. **Secondary**: Anthropic-specific request body format (e.g., `anthropic_version`, top-level `system`)

**Contrast with Codex**: Codex (OpenAI) *is* detected via `User-Agent` containing "codex" (e.g., `codex-cli/1.0.0`), which takes precedence in the detection order.

### Detection Logic

The ccr-rust frontend detection uses this priority order:

```rust
1. User-Agent contains "codex" -> Codex
2. Any anthropic-* header present -> Claude Code
3. Body has Anthropic format (anthropic_version field, top-level system field) -> Claude Code
4. Body has OpenAI format (messages with roles) -> Codex
5. Default -> Claude Code
```

### Request Format Indicators

In addition to headers, Claude Code requests have these body characteristics:

- **Top-level `system` field**: Anthropic places system prompts at the top level, not in the messages array
- **`anthropic_version` field**: e.g., `"anthropic_version": "2023-06-01"`
- **Content blocks**: Messages use content arrays with typed blocks (e.g., `{"type": "text", "text": "..."}`)

### Response Headers Set by ccr-rust

When processing Claude Code requests, ccr-rust adds:

| Header | Description |
|--------|-------------|
| `x-ccr-tier` | The backend tier that served the request |

## Thinking Blocks

Claude Code supports extended thinking (reasoning) capabilities through the `thinking` content block type. When enabled, Claude outputs internal reasoning before delivering final answers. CCR-Rust handles thinking block transformation automatically for both native Anthropic models and third-party reasoning models (e.g., DeepSeek Reasoner).

### Thinking Content Block Format

Anthropic Messages API returns thinking blocks as content blocks with the following structure:

```json
{
  "type": "thinking",
  "thinking": "Let me analyze this step by step...",
  "signature": "WaUjzkypQ2mUEVM36O2TxuC06KN8xyfbJwyem2dw3URve/op91XWHOEBLLqIOMfFG/UvLEczmEsUjavL...."
}
```

**Fields:**

| Field | Type | Description |
|-------|------|-------------|
| `type` | string | Always `"thinking"` for thinking blocks |
| `thinking` | string | The model's internal reasoning content (human-readable) |
| `signature` | string | Encrypted signature for verification (see below) |

Thinking blocks appear **before** text blocks in the response `content` array:

```json
{
  "content": [
    {
      "type": "thinking",
      "thinking": "Let me analyze this...",
      "signature": "..."
    },
    {
      "type": "text",
      "text": "Based on my analysis..."
    }
  ]
}
```

### Signature Field Usage

The `signature` field contains encrypted verification data that proves the thinking block was generated by Claude. This field serves the following purposes:

1. **Verification**: Ensures thinking blocks passed back to the API are authentic and unmodified
2. **Security**: Prevents tampering with reasoning content in multi-turn conversations
3. **Continuity**: Required when using extended thinking with tool use

**Key characteristics:**

- Signatures are significantly longer in Claude 4 models compared to earlier models
- The field is **opaque** — do not parse or interpret its contents
- Signatures are **platform-compatible** (work across Anthropic API, AWS Bedrock, and Vertex AI)
- In streaming responses, the signature arrives via `signature_delta` events

**Streaming signature delivery:**

```json
{
  "type": "content_block_delta",
  "index": 0,
  "delta": {
    "type": "signature_delta",
    "signature": "EqQBCgIYAhIM1gbcDa9GJwZA2b3hGgxBdjrkzLoky3dl1pkiMOYds..."
  }
}
```

**CCR-Rust handling:**
- For native Anthropic models: Signatures are passed through unchanged
- For non-Anthropic models (e.g., DeepSeek): An empty `signature: ""` is added for API compatibility

### Redacted Thinking Blocks

Occasionally, Claude's internal reasoning is flagged by safety systems. When this occurs, the API encrypts some or all of the thinking content and returns it as a `redacted_thinking` block.

**Redacted thinking format:**

```json
{
  "type": "redacted_thinking",
  "data": "EmwKAhgBEgy3va3pzix/LafPsn4aDFIT2Xlxh0L5L8rLVyIwxtE3rAFBa8cr3qpPkNRj2YfWXGmKDxH4mPnZ5sQ7vB9URj2pLmN3kF8/dW5hR7xJ0aP1oLs9yTcMnKVf2wRpEGjH9XZaBt4UvDcPrQ..."
}
```

**Key characteristics:**

| Field | Type | Description |
|-------|------|-------------|
| `type` | string | Always `"redacted_thinking"` |
| `data` | string | Encrypted thinking content (not human-readable) |

**Important behaviors:**

1. **Automatic decryption**: When passed back to the API, `redacted_thinking` blocks are automatically decrypted
2. **Model continuity**: The model can still use redacted reasoning to inform responses
3. **Expected behavior**: Seeing redacted thinking is normal and doesn't affect response quality
4. **Display guidance**: When showing thinking to users, filter out redacted blocks while preserving normal thinking blocks

**Test trigger string:**
To test redacted thinking handling, use this magic prompt:
```
ANTHROPIC_MAGIC_STRING_TRIGGER_REDACTED_THINKING_46C9A13E193C177646C7398A98432ECCCE4C1253D5E2D82641AC0E52CC2876CB
```

### CCR-Rust Transformation

CCR-Rust normalizes thinking blocks from various backends into the Anthropic format:

**From DeepSeek (reasoning models):**
```json
// DeepSeek response
{
  "reasoning_content": "Let me think step by step...",
  "content": "The answer is 42."
}

// Transformed to Anthropic format
{
  "content": [
    {"type": "thinking", "thinking": "Let me think step by step...", "signature": ""},
    {"type": "text", "text": "The answer is 42."}
  ]
}
```

**Streaming transformation:**
- `reasoning_content` deltas → `thinking_delta` events
- Regular `content` deltas → `text_delta` events

### Best Practices

1. **Preserve thinking blocks**: When using tool use with extended thinking, always pass complete unmodified thinking blocks back to the API
2. **Don't toggle mid-turn**: Thinking mode must remain consistent throughout an assistant turn (including tool loops)
3. **Handle redaction gracefully**: Filter redacted blocks from UI while preserving them in API calls
4. **Token budgeting**: `budget_tokens` must be less than `max_tokens` (except with interleaved thinking)
